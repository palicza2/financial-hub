<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="A financial hub with calculators for annuity loans and savings projections. Visualize amortization schedules and long-term investment growth.">
    <title>Financial Hub</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><rect width='32' height='32' rx='5' fill='%234f46e5'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='Inter, sans-serif' font-size='16' font-weight='bold' fill='white'>FH</text></svg>">
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS (xlsx) for Excel generation -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* A light gray as a fallback */
            background-image: linear-gradient(to top right, #f8fafc, #e0e7ff); /* Subtle gradient */
        }
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        .tab-button.active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <main class="container mx-auto">
        <div class="bg-white/70 backdrop-blur-sm rounded-2xl shadow-xl p-6 md:p-8 max-w-4xl mx-auto border border-gray-200">

            <!-- Tab Navigation -->
            <div class="flex border-b border-gray-300 mb-6">
                <button id="annuity-tab-btn" class="tab-button active flex-1 sm:flex-none text-gray-500 font-semibold py-3 px-6 border-b-2 border-transparent hover:text-indigo-600 transition">Annuity Calculator</button>
                <button id="savings-tab-btn" class="tab-button flex-1 sm:flex-none text-gray-500 font-semibold py-3 px-6 border-b-2 border-transparent hover:text-indigo-600 transition">Savings Calculator</button>
            </div>

            <!-- Annuity Calculator Content -->
            <div id="annuity-content">
                <!-- Header Section -->
                <header class="text-center mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Annuity Calculator</h1>
                    <p class="text-gray-500 mt-2">Calculate your monthly loan payments and see the principal vs. interest breakdown.</p>
                </header>

                <!-- Input Form Section -->
                <section aria-labelledby="form-heading">
                    <h2 id="form-heading" class="sr-only">Loan Details Form</h2>
                    <form id="loan-form" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div>
                            <label for="loanAmount" class="block text-sm font-medium text-gray-700 mb-2">Loan Amount (Ft)</label>
                            <div class="flex items-center bg-white border border-gray-300 rounded-lg focus-within:ring-2 focus-within:ring-indigo-500 transition duration-150 overflow-hidden">
                               <span class="px-3 py-2 text-gray-500 border-r border-gray-300 bg-gray-50">Ft</span>
                               <input type="number" id="loanAmount" value="100000000" class="w-full px-3 py-2 bg-transparent border-0 focus:ring-0 text-gray-800" placeholder="100000000">
                            </div>
                        </div>
                        <div>
                            <label for="interestRate" class="block text-sm font-medium text-gray-700 mb-2">Annual Interest Rate (%)</label>
                            <div class="flex items-center bg-white border border-gray-300 rounded-lg focus-within:ring-2 focus-within:ring-indigo-500 transition duration-150 overflow-hidden">
                               <span class="px-3 py-2 text-gray-500 border-r border-gray-300 bg-gray-50">%</span>
                               <input type="number" id="interestRate" step="0.01" value="5" class="w-full px-3 py-2 bg-transparent border-0 focus:ring-0 text-gray-800" placeholder="5">
                            </div>
                        </div>
                        <div>
                            <label for="loanTerm" class="block text-sm font-medium text-gray-700 mb-2">Loan Term (Years)</label>
                            <div class="flex items-center bg-white border border-gray-300 rounded-lg focus-within:ring-2 focus-within:ring-indigo-500 transition duration-150 overflow-hidden">
                                <div class="px-3 py-2 text-gray-500 border-r border-gray-300 bg-gray-50 flex items-center justify-center">
                                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 0 1 2.25-2.25h13.5A2.25 2.25 0 0 1 21 7.5v11.25m-18 0A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75m-18 0h18M12 15.75h.008v.008H12v-.008Z" /></svg>
                                </div>
                               <input type="number" id="loanTerm" value="25" class="w-full px-3 py-2 bg-transparent border-0 focus:ring-0 text-gray-800" placeholder="25">
                            </div>
                        </div>
                         <div class="md:col-span-3 flex items-center justify-center mt-2">
                            <input type="checkbox" id="gracePeriod" name="gracePeriod" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                            <label for="gracePeriod" class="ml-2 block text-sm text-gray-900">1-Year Grace Period (Interest-Only)</label>
                        </div>
                        <div class="md:col-span-3 text-center">
                            <button type="submit" class="w-full md:w-auto bg-indigo-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition transform hover:scale-105">Calculate</button>
                        </div>
                    </form>
                </section>
                
                <div id="annuity-error-message" class="hidden text-center bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
                    <strong class="font-bold">Invalid Input!</strong>
                    <span class="block sm:inline">Please enter valid, positive numbers for all fields.</span>
                </div>

                <section id="annuity-results-section" class="hidden" aria-labelledby="annuity-results-heading">
                     <h2 id="annuity-results-heading" class="sr-only">Loan Calculation Results</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 text-center mb-8 bg-indigo-50 p-6 rounded-lg">
                        <div>
                            <h3 id="monthlyPaymentLabel" class="text-lg font-medium text-gray-600">Your Monthly Payment</h3>
                            <p id="monthlyPayment" class="text-3xl sm:text-4xl font-bold text-indigo-600 mt-2"></p>
                        </div>
                        <div>
                            <h3 class="text-lg font-medium text-gray-600">Total Repayable Amount</h3>
                            <p id="totalRepayable" class="text-3xl sm:text-4xl font-bold text-gray-700 mt-2"></p>
                        </div>
                    </div>
                    <div class="text-center mb-8">
                         <button id="download-excel" class="hidden w-full sm:w-auto bg-green-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition transform hover:scale-105">Download Excel Report</button>
                    </div>
                    <div class="w-full h-72 md:h-96 bg-gray-50 p-2 sm:p-4 rounded-lg shadow-inner"><canvas id="paymentChart"></canvas></div>
                    <div class="mt-8">
                        <h3 class="text-xl font-semibold text-gray-700 text-center mb-4">Amortization Schedule</h3>
                        <div class="max-h-96 overflow-y-auto custom-scrollbar border border-gray-200 rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-100 sticky top-0"><tr><th scope="col" class="px-2 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Month</th><th scope="col" class="px-2 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Principal</th><th scope="col" class="px-2 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Interest</th><th scope="col" class="px-2 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Payment</th><th scope="col" class="px-2 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Remaining Balance</th></tr></thead>
                                <tbody id="amortization-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </div>
            
            <!-- Savings Calculator Content -->
            <div id="savings-content" class="hidden">
                 <header class="text-center mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-800">Savings Calculator</h1>
                    <p class="text-gray-500 mt-2">Project the future value of your savings and see your capital grow.</p>
                </header>

                <section aria-labelledby="savings-form-heading">
                    <h2 id="savings-form-heading" class="sr-only">Savings Details Form</h2>
                    <form id="savings-form" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div>
                            <label for="monthlySaving" class="block text-sm font-medium text-gray-700 mb-2">Monthly Saving (Ft)</label>
                            <div class="flex items-center bg-white border border-gray-300 rounded-lg focus-within:ring-2 focus-within:ring-indigo-500 transition duration-150 overflow-hidden">
                               <span class="px-3 py-2 text-gray-500 border-r border-gray-300 bg-gray-50">Ft</span>
                               <input type="number" id="monthlySaving" value="50000" class="w-full px-3 py-2 bg-transparent border-0 focus:ring-0 text-gray-800" placeholder="50000">
                            </div>
                        </div>
                        <div>
                            <label for="inflationRate" class="block text-sm font-medium text-gray-700 mb-2">Annual Inflation Rate (%)</label>
                            <div class="flex items-center bg-white border border-gray-300 rounded-lg focus-within:ring-2 focus-within:ring-indigo-500 transition duration-150 overflow-hidden">
                               <span class="px-3 py-2 text-gray-500 border-r border-gray-300 bg-gray-50">%</span>
                               <input type="number" id="inflationRate" step="0.01" value="3" class="w-full px-3 py-2 bg-transparent border-0 focus:ring-0 text-gray-800" placeholder="3">
                            </div>
                        </div>
                        <div>
                            <label for="realYieldRate" class="block text-sm font-medium text-gray-700 mb-2">Annual Real Yield (%)</label>
                            <div class="flex items-center bg-white border border-gray-300 rounded-lg focus-within:ring-2 focus-within:ring-indigo-500 transition duration-150 overflow-hidden">
                               <span class="px-3 py-2 text-gray-500 border-r border-gray-300 bg-gray-50">%</span>
                               <input type="number" id="realYieldRate" step="0.01" value="4" class="w-full px-3 py-2 bg-transparent border-0 focus:ring-0 text-gray-800" placeholder="4">
                            </div>
                        </div>
                        <div class="md:col-span-3 text-center">
                            <button type="submit" class="w-full md:w-auto bg-indigo-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition transform hover:scale-105">Calculate Savings</button>
                        </div>
                    </form>
                </section>
                
                <div id="savings-error-message" class="hidden text-center bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
                    <strong class="font-bold">Invalid Input!</strong>
                    <span class="block sm:inline">Please enter valid numbers for all fields.</span>
                </div>

                <section id="savings-results-section" class="hidden" aria-labelledby="savings-results-heading">
                     <h2 id="savings-results-heading" class="sr-only">Savings Calculation Results</h2>
                     <div class="grid grid-cols-1 gap-6 text-center mb-8 bg-indigo-50 p-6 rounded-lg">
                        <div>
                            <h3 class="text-lg font-medium text-gray-600">Future Value (After 50 Years)</h3>
                            <p id="futureValue" class="text-3xl sm:text-4xl font-bold text-indigo-600 mt-2"></p>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                             <div>
                                <h3 class="text-md font-medium text-gray-600">Total Capital Invested</h3>
                                <p id="totalCapital" class="text-2xl font-semibold text-gray-700 mt-1"></p>
                            </div>
                             <div>
                                <h3 class="text-md font-medium text-gray-600">Total Gains</h3>
                                <p id="totalGains" class="text-2xl font-semibold text-gray-700 mt-1"></p>
                            </div>
                        </div>
                    </div>
                     <div class="text-center mb-8">
                         <button id="download-savings-excel" class="hidden w-full sm:w-auto bg-green-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition transform hover:scale-105">Download Excel Report</button>
                    </div>
                    <div class="w-full h-72 md:h-96 bg-gray-50 p-2 sm:p-4 rounded-lg shadow-inner"><canvas id="savingsChart"></canvas></div>
                    <div class="mt-8">
                        <h3 class="text-xl font-semibold text-gray-700 text-center mb-4">Yearly Savings Growth</h3>
                        <div class="max-h-96 overflow-y-auto custom-scrollbar border border-gray-200 rounded-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-100 sticky top-0"><tr><th scope="col" class="px-2 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Year</th><th scope="col" class="px-2 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Capital Invested</th><th scope="col" class="px-2 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gains</th><th scope="col" class="px-2 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Value</th></tr></thead>
                                <tbody id="savings-breakdown-body" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <script>
        // --- COMMON ELEMENTS & FUNCTIONS ---
        const formatCurrency = (num) => {
            return new Intl.NumberFormat('hu-HU', {
                style: 'currency',
                currency: 'HUF',
                maximumFractionDigits: 0,
                minimumFractionDigits: 0
            }).format(num);
        };

        // --- TAB SWITCHING LOGIC ---
        const annuityTabBtn = document.getElementById('annuity-tab-btn');
        const savingsTabBtn = document.getElementById('savings-tab-btn');
        const annuityContent = document.getElementById('annuity-content');
        const savingsContent = document.getElementById('savings-content');
        
        annuityTabBtn.addEventListener('click', () => {
            annuityContent.classList.remove('hidden');
            savingsContent.classList.add('hidden');
            annuityTabBtn.classList.add('active');
            savingsTabBtn.classList.remove('active');
        });

        savingsTabBtn.addEventListener('click', () => {
            savingsContent.classList.remove('hidden');
            annuityContent.classList.add('hidden');
            savingsTabBtn.classList.add('active');
            annuityTabBtn.classList.remove('active');
        });

        // --- ANNUITY CALCULATOR LOGIC ---
        (function() {
            const loanForm = document.getElementById('loan-form');
            const resultsSection = document.getElementById('annuity-results-section');
            const monthlyPaymentEl = document.getElementById('monthlyPayment');
            const monthlyPaymentLabel = document.getElementById('monthlyPaymentLabel');
            const totalRepayableEl = document.getElementById('totalRepayable');
            const errorMessage = document.getElementById('annuity-error-message');
            const downloadBtn = document.getElementById('download-excel');
            const chartCanvas = document.getElementById('paymentChart');
            const amortizationBody = document.getElementById('amortization-body');
            let paymentChart = null;

            const generateAndDownloadExcel = (principal, annualInterestRate, years, hasGracePeriod) => {
                const numberOfPayments = years * 12;
                const wb = XLSX.utils.book_new();
                const ws_name = "Amortization Schedule";
                const ws = {};
                const encode = (r, c) => XLSX.utils.encode_cell({ r, c });
                const currencyFormat = `"Ft" #,##0`;

                ws[encode(0, 0)] = { t: 's', v: 'Loan Amount' };
                ws[encode(1, 0)] = { t: 's', v: 'Annual Interest Rate' };
                ws[encode(2, 0)] = { t: 's', v: 'Loan Term (Years)' };
                ws[encode(3, 0)] = { t: 's', v: 'Grace Period' };
                ws[encode(0, 1)] = { t: 'n', v: principal, z: currencyFormat };
                ws[encode(1, 1)] = { t: 'n', v: annualInterestRate / 100, z: '0.00%' };
                ws[encode(2, 1)] = { t: 'n', v: years };
                ws[encode(3, 1)] = { t: 's', v: (hasGracePeriod && years > 1) ? 'Yes (1 Year)' : 'No' };
                
                const headers = ["Month", "Principal", "Interest", "Total Payment", "Remaining Balance"];
                let headerRowIndex = 7;

                if (hasGracePeriod && years > 1) {
                    ws[encode(5, 0)] = { t: 's', v: 'Interest-Only Payment (Months 1-12)' };
                    ws[encode(5, 1)] = { t: 'n', f: `B1*(B2/12)`, z: currencyFormat };
                    ws[encode(6, 0)] = { t: 's', v: 'Standard Payment (Months 13+)' };
                    ws[encode(6, 1)] = { t: 'n', f: `PMT(B2/12, (B3-1)*12, -B1)`, z: currencyFormat };
                    headerRowIndex = 8;
                } else {
                    ws[encode(5, 0)] = { t: 's', v: 'Monthly Payment' };
                    ws[encode(5, 1)] = { t: 'n', f: `PMT(B2/12, B3*12, -B1)`, z: currencyFormat };
                }

                headers.forEach((h, c) => { ws[encode(headerRowIndex, c)] = { t: 's', v: h, s: { font: { bold: true } } }; });
                ws[encode(headerRowIndex + 1, 4)] = { t: 'n', f: 'B1', z: currencyFormat };

                for (let i = 0; i < numberOfPayments; i++) {
                    const r = headerRowIndex + 2 + i; const prev_r = r - 1;
                    ws[encode(r, 0)] = { t: 'n', v: i + 1 };
                    ws[encode(r, 2)] = { t: 'n', f: `${encode(prev_r, 4)}*($B$2/12)`, z: currencyFormat };
                    if (hasGracePeriod && years > 1 && i < 12) {
                        ws[encode(r, 1)] = { t: 'n', v: 0, z: currencyFormat };
                        ws[encode(r, 3)] = { t: 'n', f: `${encode(r, 2)}`, z: currencyFormat };
                    } else {
                        const paymentCell = (hasGracePeriod && years > 1) ? '$B$7' : '$B$6';
                        ws[encode(r, 3)] = { t: 'n', f: paymentCell, z: currencyFormat };
                        ws[encode(r, 1)] = { t: 'n', f: `${encode(r, 3)} - ${encode(r, 2)}`, z: currencyFormat };
                    }
                    ws[encode(r, 4)] = { t: 'n', f: `${encode(prev_r, 4)} - ${encode(r, 1)}`, z: currencyFormat };
                }

                ws['!cols'] = [{ wch: 10 }, { wch: 20 }, { wch: 20 }, { wch: 20 }, { wch: 25 }];
                let maxRow = Object.keys(ws).reduce((max, cell) => Math.max(max, XLSX.utils.decode_cell(cell).r), 0);
                ws['!ref'] = XLSX.utils.encode_range({ s: { c: 0, r: 0 }, e: { c: headers.length, r: maxRow } });
                XLSX.utils.book_append_sheet(wb, ws, ws_name);
                XLSX.writeFile(wb, 'Financial-Hub_Annuity_Report.xlsx');
            };

            loanForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const principal = parseFloat(document.getElementById('loanAmount').value);
                const annualInterestRate = parseFloat(document.getElementById('interestRate').value);
                const years = parseInt(document.getElementById('loanTerm').value);
                const hasGracePeriod = document.getElementById('gracePeriod').checked;
                
                if (isNaN(principal) || isNaN(annualInterestRate) || isNaN(years) || principal <= 0 || annualInterestRate < 0 || years <= 0) {
                    errorMessage.classList.remove('hidden'); resultsSection.classList.add('hidden'); downloadBtn.classList.add('hidden'); return;
                } else if (hasGracePeriod && years <= 1) {
                    errorMessage.querySelector('span').textContent = 'Grace period requires a loan term longer than 1 year.';
                    errorMessage.classList.remove('hidden'); resultsSection.classList.add('hidden'); downloadBtn.classList.add('hidden'); return;
                } else { errorMessage.classList.add('hidden'); }

                const monthlyInterestRate = annualInterestRate / 100 / 12;
                const numberOfPayments = years * 12;
                let totalRepayable; const amortizationPayments = []; let balance = principal;

                if (hasGracePeriod && years > 1) {
                    monthlyPaymentLabel.textContent = "Monthly Payment (After Grace Period)";
                    const interestOnlyPayment = principal * monthlyInterestRate;
                    for (let i = 1; i <= 12; i++) { amortizationPayments.push({ month: i, principal: 0, interest: interestOnlyPayment, totalPayment: interestOnlyPayment, balance: balance }); }
                    const remainingPayments = numberOfPayments - 12;
                    const x = Math.pow(1 + monthlyInterestRate, remainingPayments);
                    const standardPayment = (principal * x * monthlyInterestRate) / (x - 1);
                    monthlyPaymentEl.textContent = formatCurrency(standardPayment);
                    for (let i = 1; i <= remainingPayments; i++) {
                        const interestForMonth = balance * monthlyInterestRate; const principalForMonth = standardPayment - interestForMonth; balance -= principalForMonth;
                        amortizationPayments.push({ month: 12 + i, principal: principalForMonth, interest: interestForMonth, totalPayment: standardPayment, balance: Math.abs(balance) });
                    }
                    totalRepayable = (12 * interestOnlyPayment) + (remainingPayments * standardPayment);
                } else {
                    monthlyPaymentLabel.textContent = "Your Monthly Payment";
                    const x = Math.pow(1 + monthlyInterestRate, numberOfPayments);
                    const monthlyPayment = (principal * x * monthlyInterestRate) / (x - 1);
                    if (!isFinite(monthlyPayment)) { errorMessage.querySelector('span').textContent = 'Calculation resulted in an invalid number.'; errorMessage.classList.remove('hidden'); resultsSection.classList.add('hidden'); return; }
                    monthlyPaymentEl.textContent = formatCurrency(monthlyPayment);
                    for (let i = 1; i <= numberOfPayments; i++) {
                        const interestForMonth = balance * monthlyInterestRate; const principalForMonth = monthlyPayment - interestForMonth; balance -= principalForMonth;
                        amortizationPayments.push({ month: i, principal: principalForMonth, interest: interestForMonth, totalPayment: monthlyPayment, balance: Math.abs(balance) });
                    }
                    totalRepayable = monthlyPayment * numberOfPayments;
                }

                totalRepayableEl.textContent = formatCurrency(totalRepayable);
                resultsSection.classList.remove('hidden');
                amortizationBody.innerHTML = '';
                amortizationPayments.forEach(p => {
                    const row = `<tr class="hover:bg-gray-50 transition-colors"><td class="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-500">${p.month}</td><td class="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(p.principal)}</td><td class="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(p.interest)}</td><td class="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${formatCurrency(p.totalPayment)}</td><td class="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(p.balance)}</td></tr>`;
                    amortizationBody.insertAdjacentHTML('beforeend', row);
                });

                if (paymentChart) { paymentChart.destroy(); }
                paymentChart = new Chart(chartCanvas, {
                    type: 'bar',
                    data: { labels: amortizationPayments.map(p => `Month ${p.month}`), datasets: [{ label: 'Principal', data: amortizationPayments.map(p => p.principal.toFixed(2)), backgroundColor: 'rgba(79, 70, 229, 0.8)', borderRadius: 4 }, { label: 'Interest', data: amortizationPayments.map(p => p.interest.toFixed(2)), backgroundColor: 'rgba(225, 29, 72, 0.7)', borderRadius: 4 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { title: { display: true, text: 'Principal vs. Interest Payment Over Time', font: { size: 16 }, color: '#374151' }, tooltip: { callbacks: { label: (context) => `${context.dataset.label || ''}: ${formatCurrency(context.parsed.y)}` } } }, scales: { x: { stacked: true, title: { display: true, text: 'Months' }, grid: { display: false } }, y: { stacked: true, title: { display: true, text: 'Payment Amount (Ft)' }, ticks: { callback: (value) => `${value.toLocaleString('hu-HU')} Ft` } } } }
                });
                
                downloadBtn.classList.remove('hidden');
                const excelDownloadHandler = () => generateAndDownloadExcel(principal, annualInterestRate, years, hasGracePeriod);
                if (downloadBtn.handler) { downloadBtn.removeEventListener('click', downloadBtn.handler); }
                downloadBtn.addEventListener('click', excelDownloadHandler);
                downloadBtn.handler = excelDownloadHandler;
            });
            loanForm.dispatchEvent(new Event('submit'));
        })();

        // --- SAVINGS CALCULATOR LOGIC ---
        (function() {
            const savingsForm = document.getElementById('savings-form');
            const resultsSection = document.getElementById('savings-results-section');
            const futureValueEl = document.getElementById('futureValue');
            const totalCapitalEl = document.getElementById('totalCapital');
            const totalGainsEl = document.getElementById('totalGains');
            const errorMessage = document.getElementById('savings-error-message');
            const downloadBtn = document.getElementById('download-savings-excel');
            const chartCanvas = document.getElementById('savingsChart');
            const breakdownBody = document.getElementById('savings-breakdown-body');
            let savingsChart = null;
            const savingsYears = 50;

            const generateAndDownloadSavingsExcel = (monthlySaving, inflationRate, realYieldRate) => {
                const wb = XLSX.utils.book_new();
                const ws_name = "Savings Projection";
                const ws = {};
                const encode = (r, c) => XLSX.utils.encode_cell({ r, c });
                const currencyFormat = `"Ft" #,##0`;
                const percentFormat = '0.00%';

                // Inputs
                ws[encode(0, 0)] = { t: 's', v: 'Monthly Saving' };
                ws[encode(1, 0)] = { t: 's', v: 'Annual Inflation Rate' };
                ws[encode(2, 0)] = { t: 's', v: 'Annual Real Yield' };
                ws[encode(0, 1)] = { t: 'n', v: monthlySaving, z: currencyFormat };
                ws[encode(1, 1)] = { t: 'n', v: inflationRate / 100, z: percentFormat };
                ws[encode(2, 1)] = { t: 'n', v: realYieldRate / 100, z: percentFormat };

                // Calculated Nominal Yield
                ws[encode(4, 0)] = { t: 's', v: 'Calculated Nominal Yield' };
                ws[encode(4, 1)] = { t: 'n', f: `(1+B2)*(1+B3)-1`, z: percentFormat };

                // Table Headers
                const headers = ["Year", "Capital Invested", "Gains", "Total Value"];
                const headerRowIndex = 6;
                headers.forEach((h, c) => { ws[encode(headerRowIndex, c)] = { t: 's', v: h, s: { font: { bold: true } } }; });

                // Table Data with formulas
                for (let i = 0; i < savingsYears; i++) {
                    const r = headerRowIndex + 1 + i;
                    const prev_r = r - 1;

                    // Year
                    ws[encode(r, 0)] = { t: 'n', v: i + 1 };
                    
                    // Total Value (D)
                    if (i === 0) {
                        ws[encode(r, 3)] = { t: 'n', f: `($B$1*12)*(1+$B$5)`, z: currencyFormat };
                    } else {
                        ws[encode(r, 3)] = { t: 'n', f: `(${encode(prev_r, 3)}+($B$1*12))*(1+$B$5)`, z: currencyFormat };
                    }
                    
                    // Capital Invested (B)
                    ws[encode(r, 1)] = { t: 'n', f: `A${r+1}*($B$1*12)`, z: currencyFormat };
                    
                    // Gains (C)
                    ws[encode(r, 2)] = { t: 'n', f: `D${r+1}-B${r+1}`, z: currencyFormat };
                }

                ws['!cols'] = [{ wch: 10 }, { wch: 20 }, { wch: 20 }, { wch: 20 }];
                let maxRow = Object.keys(ws).reduce((max, cell) => Math.max(max, XLSX.utils.decode_cell(cell).r), 0);
                ws['!ref'] = XLSX.utils.encode_range({ s: { c: 0, r: 0 }, e: { c: headers.length, r: maxRow } });
                XLSX.utils.book_append_sheet(wb, ws, ws_name);
                XLSX.writeFile(wb, 'Financial-Hub_Savings_Report.xlsx');
            };


            savingsForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const monthlySaving = parseFloat(document.getElementById('monthlySaving').value);
                const inflationRate = parseFloat(document.getElementById('inflationRate').value);
                const realYieldRate = parseFloat(document.getElementById('realYieldRate').value);

                if (isNaN(monthlySaving) || isNaN(inflationRate) || isNaN(realYieldRate) || monthlySaving <= 0) {
                    errorMessage.classList.remove('hidden'); resultsSection.classList.add('hidden'); return;
                } else { errorMessage.classList.add('hidden'); }

                const nominalYield = (1 + (realYieldRate / 100)) * (1 + (inflationRate / 100)) - 1;
                let balance = 0;
                let totalCapital = 0;
                const savingsData = [];

                for (let year = 1; year <= savingsYears; year++) {
                    let yearlyCapital = monthlySaving * 12;
                    let interestThisYear = balance * nominalYield;
                    balance += yearlyCapital + interestThisYear;
                    totalCapital += yearlyCapital;
                    const totalGains = balance - totalCapital;
                    savingsData.push({ year, capital: totalCapital, gains: totalGains, total: balance });
                }
                
                const finalResult = savingsData[savingsData.length - 1];
                futureValueEl.textContent = formatCurrency(finalResult.total);
                totalCapitalEl.textContent = formatCurrency(finalResult.capital);
                totalGainsEl.textContent = formatCurrency(finalResult.gains);
                resultsSection.classList.remove('hidden');

                breakdownBody.innerHTML = '';
                savingsData.forEach(d => {
                    const row = `<tr class="hover:bg-gray-50 transition-colors"><td class="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-500">${d.year}</td><td class="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(d.capital)}</td><td class="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900">${formatCurrency(d.gains)}</td><td class="px-2 sm:px-6 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${formatCurrency(d.total)}</td></tr>`;
                    breakdownBody.insertAdjacentHTML('beforeend', row);
                });

                if (savingsChart) { savingsChart.destroy(); }
                savingsChart = new Chart(chartCanvas, {
                    type: 'bar',
                    data: {
                        labels: savingsData.map(d => d.year),
                        datasets: [
                            { label: 'Capital Invested', data: savingsData.map(d => d.capital), backgroundColor: 'rgba(59, 130, 246, 0.8)', borderRadius: 4 },
                            { label: 'Gains', data: savingsData.map(d => d.gains), backgroundColor: 'rgba(22, 163, 74, 0.8)', borderRadius: 4 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { title: { display: true, text: 'Growth of Savings: Capital vs. Gains', font: { size: 16 }, color: '#374151' }, tooltip: { callbacks: { label: (context) => `${context.dataset.label || ''}: ${formatCurrency(context.parsed.y)}` } } },
                        scales: { x: { stacked: true, title: { display: true, text: 'Years' } }, y: { stacked: true, title: { display: true, text: 'Value (Ft)' }, ticks: { callback: (value) => `${(value / 1000000).toFixed(1)}M Ft` } } }
                    }
                });

                downloadBtn.classList.remove('hidden');
                const excelDownloadHandler = () => generateAndDownloadSavingsExcel(monthlySaving, inflationRate, realYieldRate);
                if (downloadBtn.handler) { downloadBtn.removeEventListener('click', downloadBtn.handler); }
                downloadBtn.addEventListener('click', excelDownloadHandler);
                downloadBtn.handler = excelDownloadHandler;
            });
             savingsForm.dispatchEvent(new Event('submit'));
        })();
        
        document.addEventListener('DOMContentLoaded', () => {
           // Both forms are triggered inside their IIFE blocks.
        });
    </script>
</body>
</html>

